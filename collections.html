<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Collections â€” Mahesh</title>

    <link rel="apple-touch-icon" sizes="180x180" href="./favicon/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon/favicon-16x16.png" />
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/locomotive-scroll@3.5.4/dist/locomotive-scroll.css" />
    <script src="https://kit.fontawesome.com/ae8ff12b97.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="./fonts.css" />

    <style>
         :root {
        --primary-padding: 5.2vw;
        --bg-primary: #efeded;
        --bg-secondary: #f9f8f9;
        --bg-tertiary: #fff;
        --text-primary: #363636;
        --text-heading: #252425;
        --border-secondary: #c0c0c0;
        --border-tertiary: #e0e0e0;
        --accent-color: #e74c3c; /* For Favorites */
      }

      /* Dark Mode Variables */
      body.dark-mode {
        --bg-primary: #121212;
        --bg-secondary: #1e1e1e;
        --bg-tertiary: #2a2a2a;
        --text-primary: #b0b0b0;
        --text-heading: #f9f8f9;
        --border-secondary: #555555;
        --border-tertiary: #333333;
      }
      
      * { padding: 0; margin: 0; box-sizing: border-box; font-family: "Ot-light", sans-serif; }

      html, body {
        width: 100%;
        min-height: 100vh;
        background-color: var(--bg-primary);
        color: var(--text-primary);
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      
      /* Utility Classes */
      .magnetic-btn { display: inline-block; }
      .capsule {
        padding: 0.8em 1.5em;
        border-radius: 30px;
        border: 1px solid var(--border-secondary);
        background: transparent;
        color: var(--text-heading);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 10px;
        transition: all 0.3s ease;
      }
      .capsule:hover { background-color: var(--bg-secondary); border-color: var(--text-heading); }

      /* Theme Toggle */
      .theme-toggle {
          padding: 0; width: 50px; height: 50px; border-radius: 50%;
          display: flex; justify-content: center; align-items: center;
          font-size: 1.2rem; flex-shrink: 0;
          border: 1px solid var(--border-secondary);
          color: var(--text-heading); background: transparent;
          cursor: pointer; transition: all 0.3s ease;
      }
      .theme-toggle:hover { background-color: var(--bg-secondary); transform: scale(1.05); }

      /* Layout */
      #collections-main { 
          padding: var(--primary-padding); 
          min-height: 100vh;
          display: flex; /* Flex to push footer down */
          flex-direction: column; 
      }

      header {
          display: flex; justify-content: space-between; align-items: center;
          margin-bottom: 2em; flex-wrap: wrap; gap: 20px;
      }
      
      h1 { font-size: 3em; color: var(--text-heading); margin-right: auto; }

      /* Search Bar */
      .search-container {
          position: relative; flex: 1; max-width: 500px; margin: 0 20px;
      }

      .search-bar {
          width: 100%; padding: 1em 1.5em; padding-right: 3.5em;
          border-radius: 30px; border: 1px solid var(--border-secondary);
          background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px);
          color: var(--text-heading); font-size: 1rem; outline: none;
          transition: all 0.3s ease;
      }
      .search-bar:focus { border-color: var(--text-heading); background-color: var(--bg-secondary); }
      .search-icon-btn {
          position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
          background: none; border: none; color: var(--text-primary);
          cursor: pointer; opacity: 0.6; font-size: 1.1em;
      }

      /* === FILTERS BAR === */
      .filters-bar {
          display: flex; align-items: center; gap: 20px;
          margin-bottom: 1.5em; flex-wrap: wrap;
      }
      
      .filter-group {
          display: flex; align-items: center; gap: 10px;
          padding: 8px 15px; background: var(--bg-secondary);
          border-radius: 20px; border: 1px solid var(--border-tertiary);
      }
      
      .filter-label { font-size: 0.8em; opacity: 0.7; margin-right: 5px; }
      
      /* Orientation Icons */
      .orientation-btn {
          background: none; border: none; color: var(--text-primary);
          cursor: pointer; opacity: 0.5; font-size: 1.1em;
      }
      .orientation-btn.active { opacity: 1; color: var(--text-heading); }

      /* Categories */
      .collection-categories {
        position: sticky; top: 20px; z-index: 90;
        background-color: rgba(239, 237, 237, 0.85);
        backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
        padding: 1em 0; margin-bottom: 2em;
        border-bottom: 1px solid var(--border-tertiary); border-radius: 16px;
      }
      body.dark-mode .collection-categories { background-color: rgba(18, 18, 18, 0.85); }

      .categories-list {
        display: flex; gap: 2em; overflow-x: auto; padding: 0 1em;
        position: relative; align-items: center;
      }
      .categories-list::-webkit-scrollbar { display: none; }

      .collection-category-btn {
        background: none; border: none; font-size: 1.1em;
        color: var(--text-primary); cursor: pointer; opacity: 0.5;
        transition: 0.3s; white-space: nowrap;
      }
      .collection-category-btn.active { opacity: 1; color: var(--text-heading); font-family: "Ot-medium", sans-serif; }
      .collection-category-btn.favorites-tab { color: var(--accent-color); opacity: 0.8; }
      .collection-category-btn.favorites-tab.active { opacity: 1; }

      .category-underline {
        position: absolute; bottom: 0; left: 0; height: 2px;
        background-color: var(--text-heading); transition: all 0.4s cubic-bezier(0.25, 1, 0.5, 1);
      }

      /* === GALLERY === */
      .gallery-grid {
        column-count: 4; column-gap: 20px; width: 100%; min-height: 50vh;
      }

      .gallery-item {
        background-color: var(--bg-secondary); border-radius: 12px;
        overflow: hidden; position: relative; cursor: pointer;
        margin-bottom: 20px; break-inside: avoid;
        opacity: 0; transform: translateY(20px);
      }
      
      .gallery-item img {
        width: 100%; height: auto; display: block;
        transition: transform 0.5s ease;
      }

      .gallery-item:hover img { transform: scale(1.05); }

      .gallery-overlay {
          position: absolute; inset: 0;
          background: linear-gradient(to top, rgba(0,0,0,0.8), transparent 50%);
          opacity: 0; transition: opacity 0.3s ease;
          display: flex; flex-direction: column; justify-content: flex-end; padding: 15px;
      }
      .gallery-item:hover .gallery-overlay { opacity: 1; }

      /* Overlay Actions */
      .overlay-actions {
          position: absolute; top: 15px; right: 15px;
          display: flex; gap: 10px;
      }
      
      .action-btn {
          width: 35px; height: 35px; border-radius: 50%;
          background: rgba(255,255,255,0.9); border: none;
          display: flex; align-items: center; justify-content: center;
          cursor: pointer; color: #333; transform: translateY(-10px);
          transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          opacity: 0;
      }
      
      .gallery-item:hover .action-btn { opacity: 1; transform: translateY(0); }
      .gallery-item:hover .action-btn:nth-child(2) { transition-delay: 0.05s; }
      .gallery-item:hover .action-btn:nth-child(3) { transition-delay: 0.1s; }

      .action-btn:hover { background: #fff; transform: scale(1.1) !important; }
      .action-btn.fav-btn.active { color: var(--accent-color); }

      .gallery-info { color: white; font-size: 0.9em; pointer-events: none; }
      .gallery-info h3 { font-size: 1em; font-weight: 500; }
      .gallery-info p { font-size: 0.8em; opacity: 0.8; }

      /* === SKELETON LOADERS === */
      .skeleton {
          background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border-tertiary) 50%, var(--bg-secondary) 75%);
          background-size: 200% 100%;
          animation: shimmer 1.5s infinite;
          border-radius: 12px; margin-bottom: 20px;
          min-height: 200px; break-inside: avoid;
      }
      @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

      /* === LIGHTBOX === */
      .lightbox {
          position: fixed; inset: 0; z-index: 1000;
          background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
          display: flex; opacity: 0; pointer-events: none;
          transition: opacity 0.3s;
      }
      .lightbox.active { opacity: 1; pointer-events: auto; }

      .lightbox-content {
          width: 90%; max-width: 1200px; height: 90%; margin: auto;
          display: flex; gap: 40px; color: #fff;
      }

      .lightbox-img-container {
          flex: 2; display: flex; align-items: center; justify-content: center;
      }
      .lightbox-img-container img {
          max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px;
          box-shadow: 0 0 50px rgba(0,0,0,0.5);
      }

      .lightbox-details {
          flex: 1; display: flex; flex-direction: column; justify-content: center;
          overflow-y: auto;
      }
      
      .lightbox-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .lightbox-close { font-size: 2em; cursor: pointer; background: none; border: none; color: #fff; }
      
      .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin: 20px 0; }
      .tag {
          padding: 5px 12px; border-radius: 15px; background: rgba(255,255,255,0.1);
          font-size: 0.8em; cursor: pointer; transition: 0.2s;
      }
      .tag:hover { background: rgba(255,255,255,0.3); }

      .download-options { display: flex; gap: 10px; margin-top: 20px; }
      .btn-primary {
          padding: 10px 20px; background: #fff; color: #000; border: none;
          border-radius: 20px; cursor: pointer; font-weight: 600;
      }
      .btn-secondary {
          padding: 10px 20px; background: transparent; color: #fff; border: 1px solid #fff;
          border-radius: 20px; cursor: pointer;
      }

      /* Load More Button */
      .load-more-container { text-align: center; margin: 3em 0; }
      .load-more-btn {
          padding: 1em 3em; border-radius: 30px; background: var(--text-heading);
          color: var(--bg-primary); border: none; cursor: pointer;
          font-size: 1em; transition: transform 0.2s;
      }
      .load-more-btn:hover { transform: scale(1.05); }

      /* Footer Styles */
      .site-footer {
          margin-top: auto; /* Pushes footer to bottom */
          padding: 3em 0 2em 0; /* Reduced top padding */
          border-top: 1px solid var(--border-tertiary);
          text-align: center;
      }
      
      .footer-socials {
          display: flex;
          justify-content: center;
          gap: 25px;
          margin-bottom: 20px;
      }
      
      .footer-social-link {
          color: var(--text-primary);
          font-size: 1.4em;
          transition: all 0.3s ease;
          opacity: 0.7;
          display: inline-block; /* Required for transform */
      }
      
      .footer-social-link:hover {
          opacity: 1;
          color: var(--text-heading);
          /* transform handled by magnetic JS now */
      }
      
      .footer-text {
          opacity: 0.6;
          font-size: 0.9em;
      }

      /* Custom Cursor */
      .custom-cursor {
        width: 20px; height: 20px; background: #fff; border-radius: 50%;
        position: fixed; pointer-events: none; z-index: 99999; mix-blend-mode: difference; display: none;
      }
      .custom-cursor-follower {
        width: 40px; height: 40px; border: 1px solid #fff; border-radius: 50%;
        position: fixed; pointer-events: none; z-index: 99998; mix-blend-mode: difference; display: none;
      }

      @media (min-width: 768px) { .custom-cursor, .custom-cursor-follower { display: block; } }
      @media (max-width: 1200px) { .gallery-grid { column-count: 3; } }
      @media (max-width: 900px) {
          .lightbox-content { flex-direction: column; overflow-y: auto; }
          .lightbox-img-container { flex: none; height: 50%; }
          .lightbox-details { flex: none; }
      }
      @media (max-width: 800px) {
          .gallery-grid { column-count: 2; }
          header { flex-wrap: wrap; gap: 15px; }
          h1 { font-size: 2em; order: 1; margin-right: auto; }
          .theme-toggle { order: 2; }
          .search-container { width: 100%; max-width: 100%; order: 3; margin: 0; }
      }
      @media (max-width: 480px) { .gallery-grid { column-gap: 10px; } }
    </style>
</head>
<body>

    <!-- Lightbox (Modal) -->
    <div class="lightbox" id="lightbox">
        <div class="lightbox-content">
            <div class="lightbox-img-container">
                <img src="" alt="" id="lightbox-img">
            </div>
            <div class="lightbox-details">
                <div class="lightbox-header">
                    <h2 id="lightbox-user">Photographer</h2>
                    <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
                </div>
                <p id="lightbox-desc" style="opacity: 0.7; margin-bottom: 20px;">Description</p>
                
                <!-- EXIF Data -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 0.9em; opacity: 0.6; margin-bottom: 20px;">
                    <div><i class="fa-solid fa-camera"></i> <span id="exif-cam">-</span></div>
                    <div><i class="fa-solid fa-maximize"></i> <span id="exif-res">-</span></div>
                </div>

                <div class="tag-container" id="lightbox-tags"></div>

                <div class="download-options">
                    <button class="btn-primary" id="dl-full">Download Full</button>
                    <button class="btn-secondary" id="dl-reg">Regular</button>
                    <button class="btn-secondary" id="dl-small">Small</button>
                </div>
                <button class="btn-secondary" style="margin-top: 10px; width: 100%; border-color: rgba(255,255,255,0.3);" onclick="shareImage()">
                    <i class="fa-solid fa-share"></i> Share Link
                </button>
            </div>
        </div>
    </div>

    <div class="custom-cursor"></div>
    <div class="custom-cursor-follower"></div>

    <div id="main" data-scroll-container>
        <div id="collections-main" data-scroll-section>
            <header>
                <h1>Collections</h1>
                <button class="capsule theme-toggle magnetic-btn">
                    <i class="fa-solid fa-moon"></i>
                </button>
                
                <div class="search-container magnetic-btn">
                    <input type="text" id="searchInput" class="search-bar" placeholder="Search Unsplash...">
                    <button class="search-icon-btn" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
            </header>

            <!-- Filters Bar -->
            <div class="filters-bar">
                <div class="filter-group">
                    <span class="filter-label">Orientation:</span>
                    <button class="orientation-btn active" onclick="filterOrientation('')" title="Any"><i class="fa-solid fa-border-all"></i></button>
                    <button class="orientation-btn" onclick="filterOrientation('landscape')" title="Landscape"><i class="fa-regular fa-image"></i></button>
                    <button class="orientation-btn" onclick="filterOrientation('portrait')" title="Portrait"><i class="fa-solid fa-mobile-screen"></i></button>
                </div>
            </div>

            <div class="collection-categories">
                <div class="categories-list">
                    <button class="collection-category-btn favorites-tab" onclick="showFavorites()">
                        <i class="fa-solid fa-heart"></i> Favorites
                    </button>
                    <button class="collection-category-btn active" data-filter="all">All</button>
                    <button class="collection-category-btn" data-filter="anime">Anime</button>
                    <button class="collection-category-btn" data-filter="cyberpunk">Cyberpunk</button>
                    <button class="collection-category-btn" data-filter="nature">Nature</button>
                    <button class="collection-category-btn" data-filter="3d">3D</button>
                    <button class="collection-category-btn" data-filter="minimal">Minimal</button>
                    <button class="collection-category-btn" data-filter="neon">Neon</button>
                    <button class="collection-category-btn" data-filter="cars">Cars</button>
                    <button class="collection-category-btn" data-filter="architecture">Architecture</button>
                    <div class="category-underline"></div>
                </div>
            </div>
            
            <!-- Gallery Grid -->
            <div class="gallery-grid" id="gallery-grid"></div>
            
            <!-- Load More (Hidden by default) -->
            <div class="load-more-container">
                <button class="load-more-btn" id="loadMoreBtn" onclick="loadMoreImages()">Load More</button>
            </div>
            
            <footer class="site-footer">
                <div class="footer-socials">
                    <a href="#" class="footer-social-link magnetic-btn"><i class="fa-brands fa-instagram"></i></a>
                    <a href="#" class="footer-social-link magnetic-btn"><i class="fa-brands fa-x-twitter"></i></a>
                    <a href="#" class="footer-social-link magnetic-btn"><i class="fa-brands fa-dribbble"></i></a>
                </div>
                <p class="footer-text">&copy; 2024 Mahesh Dongare. Powered by Unsplash API.</p>
            </footer>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/locomotive-scroll@3.5.4/dist/locomotive-scroll.min.js"></script>

    <script>
        // ==========================================
        // CONFIGURATION: UNSPLASH API KEY
        // ==========================================
        const UNSPLASH_ACCESS_KEY = 'ASp9UTHFtknZ6yuf1ZCdRhegTTddxF8VGZNPYfQArz0'; 
        const IMAGES_PER_PAGE = 20;

        // State Management
        let state = {
            page: 1,
            query: 'editorial',
            orientation: '',
            isFavoritesView: false,
            favorites: JSON.parse(localStorage.getItem('mahesh_favorites')) || []
        };

        // Query Mapping
        const categoryQueries = {
            'all': 'editorial', 'anime': 'anime aesthetic', 'cyberpunk': 'cyberpunk city',
            'nature': 'nature landscape', '3d': '3d render abstract', 'minimal': 'minimalist',
            'neon': 'neon lights', 'cars': 'supercars', 'architecture': 'modern architecture'
        };

        // --- INIT ---
        const scroll = new LocomotiveScroll({ el: document.querySelector('#main'), smooth: true });
        const galleryGrid = document.getElementById("gallery-grid");
        const loadMoreBtn = document.getElementById("loadMoreBtn");
        const underline = document.querySelector(".category-underline");

        window.onload = () => {
            moveUnderline(document.querySelector(".collection-category-btn.active"));
            fetchImages(true); // Initial Fetch
        };

        // --- CORE FETCH FUNCTION ---
        async function fetchImages(reset = false) {
            if (state.isFavoritesView) return; // Don't fetch if viewing favorites

            if (reset) {
                state.page = 1;
                galleryGrid.innerHTML = "";
                showSkeletons(8);
                loadMoreBtn.style.display = "none";
            }

            let url = `https://api.unsplash.com/search/photos?query=${state.query}&page=${state.page}&per_page=${IMAGES_PER_PAGE}`;
            if (state.orientation) url += `&orientation=${state.orientation}`;

            try {
                const response = await fetch(url, { headers: { Authorization: `Client-ID ${UNSPLASH_ACCESS_KEY}` } });
                const data = await response.json();
                
                if (reset) galleryGrid.innerHTML = ""; // Clear skeletons
                
                if (data.results.length > 0) {
                    renderImages(data.results);
                    loadMoreBtn.style.display = "inline-block";
                } else if (reset) {
                    galleryGrid.innerHTML = `<p style="text-align:center; width:100%; padding:2em;">No results found. Try different filters.</p>`;
                }
            } catch (error) {
                console.error(error);
                galleryGrid.innerHTML = `<p style="text-align:center; width:100%;">Error: Check API Key.</p>`;
            }
        }

        // --- RENDER FUNCTION ---
        function renderImages(photos) {
            photos.forEach((photo, index) => {
                const isFav = state.favorites.some(f => f.id === photo.id);
                const item = document.createElement("div");
                item.className = "gallery-item";
                // Parallax attributes removed here

                const displayUrl = photo.urls.regular;
                
                // Prepare Data Object for Lightbox
                const photoData = JSON.stringify({
                    id: photo.id,
                    url: photo.urls.regular,
                    full: photo.urls.full,
                    small: photo.urls.small,
                    user: photo.user.name,
                    desc: photo.alt_description,
                    exif: photo.exif || {},
                    tags: photo.tags || []
                }).replace(/'/g, "&#39;");

                item.innerHTML = `
                    <img src="${displayUrl}" alt="${photo.alt_description}" loading="lazy">
                    <div class="gallery-overlay" onclick='openLightbox(${photoData})'>
                        <div class="overlay-actions" onclick="event.stopPropagation()">
                            <button class="action-btn fav-btn ${isFav ? 'active' : ''}" onclick="toggleFavorite('${photo.id}', this, ${photoData})">
                                <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                            </button>
                            <button class="action-btn" onclick="downloadImage('${photo.urls.full}', 'img-${photo.id}.jpg')">
                                <i class="fa-solid fa-download"></i>
                            </button>
                            <button class="action-btn" onclick="copyLink('${photo.links.html}')">
                                <i class="fa-solid fa-link"></i>
                            </button>
                        </div>
                        <div class="gallery-info">
                            <h3>${photo.user.name}</h3>
                        </div>
                    </div>
                `;
                galleryGrid.appendChild(item);
                
                // Animate Entry
                gsap.to(item, { opacity: 1, y: 0, duration: 0.5, delay: index * 0.05 });
            });

            // Update Locomotive Scroll Layout
            setTimeout(() => scroll.update(), 1000);
            attachHoverEffects();
        }

        function loadMoreImages() {
            state.page++;
            fetchImages(false);
        }

        // --- FAVORITES SYSTEM ---
        function toggleFavorite(id, btn, data) {
            const index = state.favorites.findIndex(f => f.id === id);
            const icon = btn.querySelector("i");
            
            if (index === -1) {
                state.favorites.push(data);
                btn.classList.add("active");
                icon.classList.remove("fa-regular");
                icon.classList.add("fa-solid");
            } else {
                state.favorites.splice(index, 1);
                btn.classList.remove("active");
                icon.classList.add("fa-regular");
                icon.classList.remove("fa-solid");
                
                if (state.isFavoritesView) {
                    // Remove from DOM immediately if in Fav view
                    btn.closest('.gallery-item').remove();
                    scroll.update();
                }
            }
            localStorage.setItem('mahesh_favorites', JSON.stringify(state.favorites));
        }

        function showFavorites() {
            state.isFavoritesView = true;
            loadMoreBtn.style.display = "none";
            
            // Update UI Tabs
            document.querySelectorAll('.collection-category-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('.favorites-tab').classList.add('active');
            moveUnderline(document.querySelector('.favorites-tab'));
            
            galleryGrid.innerHTML = "";
            if (state.favorites.length === 0) {
                galleryGrid.innerHTML = `<p style="text-align:center; width:100%; padding:2em;">No favorites yet. Go explore!</p>`;
                return;
            }
            
            const reconstructed = state.favorites.map(f => ({
                id: f.id,
                urls: { regular: f.url, full: f.full, small: f.small },
                user: { name: f.user },
                alt_description: f.desc,
                links: { html: f.url }, // simplified
                exif: f.exif,
                tags: f.tags
            }));
            renderImages(reconstructed);
        }

        // --- LIGHTBOX ---
        let currentLightboxUrl = "";
        function openLightbox(data) {
            const box = document.getElementById("lightbox");
            document.getElementById("lightbox-img").src = data.url;
            document.getElementById("lightbox-user").textContent = data.user;
            document.getElementById("lightbox-desc").textContent = data.desc || "No description";
            
            // EXIF
            const cam = data.exif?.name || "Unknown Camera";
            const exp = data.exif?.exposure_time ? `${data.exif.exposure_time}s` : "";
            document.getElementById("exif-cam").textContent = cam;
            document.getElementById("exif-res").textContent = exp;

            // Tags
            const tagsContainer = document.getElementById("lightbox-tags");
            tagsContainer.innerHTML = "";
            if(data.tags) {
                data.tags.slice(0, 5).forEach(tag => {
                    const t = document.createElement("span");
                    t.className = "tag";
                    t.innerText = "#" + tag.title;
                    t.onclick = () => { 
                        closeLightbox(); 
                        document.getElementById("searchInput").value = tag.title;
                        state.query = tag.title;
                        state.isFavoritesView = false;
                        fetchImages(true);
                    };
                    tagsContainer.appendChild(t);
                });
            }

            // Download Buttons
            document.getElementById("dl-full").onclick = () => downloadImage(data.full, `full-${data.id}.jpg`);
            document.getElementById("dl-reg").onclick = () => downloadImage(data.url, `reg-${data.id}.jpg`);
            document.getElementById("dl-small").onclick = () => downloadImage(data.small, `small-${data.id}.jpg`);
            
            currentLightboxUrl = data.url; // For sharing

            box.classList.add("active");
            scroll.stop(); // Stop locomotive scroll
        }

        function closeLightbox() {
            document.getElementById("lightbox").classList.remove("active");
            scroll.start();
        }

        // --- UTILS ---
        function showSkeletons(count) {
            for(let i=0; i<count; i++) {
                const div = document.createElement("div");
                div.className = "skeleton";
                galleryGrid.appendChild(div);
            }
        }

        function filterOrientation(orient) {
            state.orientation = orient;
            state.isFavoritesView = false;
            updateFilterUI('.orientation-btn', orient ? `[onclick*="${orient}"]` : '[title="Any"]');
            fetchImages(true);
        }

        function updateFilterUI(selector, activeSelector) {
            document.querySelectorAll(selector).forEach(el => el.classList.remove('active'));
            document.querySelector(activeSelector)?.classList.add('active');
        }

        function copyLink(url) {
            navigator.clipboard.writeText(url || currentLightboxUrl).then(() => alert("Link copied!"));
        }
        
        function shareImage() {
            if (navigator.share) {
                navigator.share({ title: 'Check this image', url: currentLightboxUrl });
            } else {
                copyLink(currentLightboxUrl);
            }
        }

        async function downloadImage(url, filename) {
            try {
                const response = await fetch(url);
                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) { window.open(url, '_blank'); }
        }

        // --- EVENT LISTENERS ---
        document.querySelectorAll(".collection-category-btn").forEach(btn => {
            if (btn.classList.contains('favorites-tab')) return;
            btn.addEventListener("click", (e) => {
                document.querySelectorAll(".collection-category-btn").forEach(b => b.classList.remove("active"));
                e.target.classList.add("active");
                moveUnderline(e.target);
                
                const filter = e.target.getAttribute("data-filter");
                state.query = categoryQueries[filter] || filter;
                state.isFavoritesView = false;
                
                document.getElementById("searchInput").value = "";
                fetchImages(true);
            });
        });

        document.getElementById("searchBtn").addEventListener("click", handleSearch);
        document.getElementById("searchInput").addEventListener("keypress", (e) => { if (e.key === "Enter") handleSearch(); });

        function handleSearch() {
            const val = document.getElementById("searchInput").value.trim();
            if(val) {
                state.query = val;
                state.isFavoritesView = false;
                document.querySelectorAll(".collection-category-btn").forEach(b => b.classList.remove("active"));
                fetchImages(true);
            }
        }

        function moveUnderline(target) {
            if(!target) return;
            const parent = target.parentElement;
            const targetRect = target.getBoundingClientRect();
            const parentRect = parent.getBoundingClientRect();
            const scrollLeft = parent.scrollLeft;
            underline.style.width = `${targetRect.width}px`;
            underline.style.left = `${(targetRect.left - parentRect.left) + scrollLeft}px`;
        }

        // Theme Toggle
        const themeBtn = document.querySelector(".theme-toggle");
        if (localStorage.getItem("theme") === "dark") document.body.classList.add("dark-mode");
        themeBtn.addEventListener("click", () => {
            document.body.classList.toggle("dark-mode");
            localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
            const icon = themeBtn.querySelector("i");
            icon.classList.toggle("fa-moon"); icon.classList.toggle("fa-sun");
        });

        // Cursor
        const cursor = document.querySelector(".custom-cursor");
        const follower = document.querySelector(".custom-cursor-follower");
        gsap.set(cursor, {xPercent: -50, yPercent: -50});
        // gsap.set(follower, {xPercent: -50, yPercent: -50});
        window.addEventListener("mousemove", e => {
            gsap.to(cursor, {x: e.clientX, y: e.clientY, duration: 0.5});
            gsap.to(follower,{opacity: 0});
        });
        function attachHoverEffects() {
            document.querySelectorAll("a, button, .gallery-item").forEach(el => {
                el.addEventListener("mouseenter", () => gsap.to(follower, {scale: 1.5, backgroundColor: "rgba(255,255,255,1)"}));
                // el.addEventListener("mouseleave", () => gsap.to(follower, {scale: 1, backgroundColor: "transparent"}));
            });
        }
        
    </script>
</body>
</html>